<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Expander Pro - Complete Edition</title>
    <style>
        /* Estilos previos ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- El contenido de la página ... -->
    </div>

    <div id="copiedToast" class="copied-toast">¡Copiado al portapapeles!</div>
    <div id="richTextArea" contenteditable="true"></div>

    <script>
        let shortcuts = JSON.parse(localStorage.getItem('shortcuts')) || {};
        const editor = document.getElementById('editor');
        const output = document.getElementById('output');
        const shortcutForm = document.getElementById('shortcutForm');
        const copiedToast = document.getElementById('copiedToast');
        const richTextArea = document.getElementById('richTextArea');

        function showToast() {
            copiedToast.classList.add('show');
            setTimeout(() => copiedToast.classList.remove('show'), 2000);
        }

        function updateLocalStorage() {
            localStorage.setItem('shortcuts', JSON.stringify(shortcuts));
            renderShortcutsList();
        }

        function renderShortcutsList() {
            const shortcutsList = document.getElementById('shortcutsList');
            shortcutsList.innerHTML = '';

            Object.entries(shortcuts).forEach(([shortcut, data]) => {
                const item = document.createElement('div');
                item.className = 'shortcut-item';
                
                const content = document.createElement('div');
                content.className = 'shortcut-content';
                content.innerHTML = `
                    <strong>${shortcut}</strong> → ${data.text || ''}
                    ${data.image ? '<br><img src="' + data.image + '" class="preview-image">' : ''}
                `;
                
                const actions = document.createElement('div');
                actions.className = 'shortcut-actions';
                actions.innerHTML = ` 
                    <button class="btn btn-danger" onclick="deleteShortcut('${shortcut}')">Eliminar</button>
                `;

                item.appendChild(content);
                item.appendChild(actions);
                shortcutsList.appendChild(item);
            });
        }

        async function copyRichContent(text, imageData) {
            try {
                const items = [];
                if (text) {
                    items.push(new ClipboardItem({
                        'text/plain': new Blob([text], { type: 'text/plain' })
                    }));
                }

                if (imageData) {
                    const response = await fetch(imageData);
                    const blob = await response.blob();
                    items.push(new ClipboardItem({ [blob.type]: blob }));
                }

                if (items.length > 0) {
                    await navigator.clipboard.write(items);
                    showToast();  // Muestra el mensaje de "Copiado al portapapeles"
                }
            } catch (error) {
                console.error('Error al copiar:', error);
                alert('Error al copiar el contenido. Por favor, intenta de nuevo.');
            }
        }

        async function expandText(input) {
            const words = input.split(' ');
            const lastWord = words[words.length - 1];

            if (shortcuts[lastWord]) {
                const shortcut = shortcuts[lastWord];
                let expansion = shortcut.text || '';

                // Copiar el contenido expandido al portapapeles
                await copyRichContent(expansion, shortcut.image);
                
                // Devolver el texto para la vista previa
                return expansion + (shortcut.image ? '<br><img src="' + shortcut.image + '" class="preview-image">' : '');
            }
            return input;
        }

        function deleteShortcut(shortcut) {
            if (confirm(`¿Eliminar el atajo "${shortcut}"?`)) {
                delete shortcuts[shortcut];
                updateLocalStorage();
            }
        }

        function clearAllShortcuts() {
            if (confirm('¿Estás seguro de que deseas eliminar todos los atajos?')) {
                shortcuts = {};
                updateLocalStorage();
            }
        }

        function exportShortcuts() {
            const dataStr = JSON.stringify(shortcuts, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mis-atajos.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        document.getElementById('importFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        shortcuts = { ...shortcuts, ...imported };
                        updateLocalStorage();
                        alert('¡Atajos importados con éxito!');
                    } catch (error) {
                        alert('Error al importar atajos. Revisa el formato del archivo.');
                    }
                };
                reader.readAsText(file);
            }
        });

        shortcutForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const shortcut = document.getElementById('shortcutText').value.trim();
            const expansion = document.getElementById('expansionText').value.trim();
            const imageFile = document.getElementById('imageFile').files[0];

            if (!shortcut.startsWith('.')) {
                alert('El atajo debe comenzar con un punto (.)');
                return;
            }

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    shortcuts[shortcut] = { text: expansion, image: event.target.result };
                    updateLocalStorage();
                    shortcutForm.reset();
                };
                reader.readAsDataURL(imageFile);
            } else {
                shortcuts[shortcut] = { text: expansion };
                updateLocalStorage();
                shortcutForm.reset();
            }
        });

        editor.addEventListener('input', async (e) => {
            const expanded = await expandText(e.target.value);
            output.innerHTML = expanded;
        });

        renderShortcutsList();
    </script>
</body>
</html>
